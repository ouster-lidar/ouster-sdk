# escape=` 
FROM mcr.microsoft.com/dotnet/framework/sdk:4.8-windowsservercore-ltsc2016 as windows-java

RUN powershell -Command `
    wget 'http://javadl.oracle.com/webapps/download/AutoDL?BundleId=210185' -Outfile 'C:\jreinstaller.exe' ; `
    Start-Process -filepath C:\jreinstaller.exe -passthru -wait -argumentlist "/s,INSTALLDIR=c:\Java\jre1.8.0_91" ; `
	del C:\jreinstaller.exe
SHELL ["cmd", "/S", "/C"]
RUN @"%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe" -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))" && SET "PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin"

# Set shell for chocolatey installs
SHELL ["powershell.exe", "-NoLogo", "-ExecutionPolicy", "Bypass"]
RUN choco install -y docker git git-lfs gcloudsdk

SHELL ["cmd", "/S", "/C"]

ENV JAVA_HOME c:\\Java\\jre1.8.0_91
RUN setx /M PATH "c:\\Java\\jre1.8.0_91\\bin`;%PATH%"
COPY leeroy_sixteenth_ouster_io.crt c:\\
RUN c:\\Java\\jre1.8.0_91\\bin\\keytool -trustcacerts -keystore "c:\\Java\\jre1.8.0_91\\lib\\security\\cacerts" -storepass changeit -noprompt -alias Root -import -file "C:\\leeroy_sixteenth_ouster_io.crt"
CMD [ "java.exe" ]

FROM windows-java as jenkins_windows_agent

SHELL ["powershell"]
ARG BASE_URL
ARG SECRET

COPY agent.jar C:\\
ENTRYPOINT ["C:\\Java\\jre1.8.0_91\\bin\\java.exe", "-jar", "C:\\agent.jar"]
