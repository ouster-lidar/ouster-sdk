cmake_minimum_required(VERSION 3.1.0)

set(CMAKE_CURRENT_SOURCE_DIR "${VERSION_GEN_SOURCE_DIR}")
set(CMAKE_CURRENT_BINARY_DIR "${VERSION_GEN_BUILD_DIR}")

execute_process(
  COMMAND git describe
  OUTPUT_VARIABLE GIT_OUTPUT
  ERROR_VARIABLE GIT_ERROR
  WORKING_DIRECTORY ${VERSION_GEN_SOURCE_DIR})
string(LENGTH "${GIT_OUTPUT}" GIT_OUTPUT_LENGTH)
string(LENGTH "${GIT_ERROR}" GIT_ERROR_LENGTH)

get_filename_component(OUSTER_EXAMPLE_STATIC_VERSION_FILE "${VERSION_GEN_SOURCE_DIR}/../VERSION" ABSOLUTE)

SET(OUSTER_EXAMPLE_VERSION_FILE "${VERSION_GEN_BUILD_DIR}/VERSION")
SET(UNKNOWN_VERSION_STRING "VERSION UNKNOWN")

if(NOT EXISTS ${OUSTER_EXAMPLE_STATIC_VERSION_FILE})
  SET(OUSTER_EXAMPLE_VERSION_FILE "${VERSION_GEN_BUILD_DIR}/VERSION")
  if(${GIT_ERROR_LENGTH} GREATER 0)
    file(WRITE ${OUSTER_EXAMPLE_VERSION_FILE} "${UNKNOWN_VERSION_STRING}")
  elseif(${GIT_OUTPUT_LENGTH} GREATER 0)
    file(WRITE ${OUSTER_EXAMPLE_VERSION_FILE} "${GIT_OUTPUT}")
  else()
    file(WRITE ${OUSTER_EXAMPLE_VERSION_FILE} "${UNKNOWN_VERSION_STRING}")
  endif()
else()
  file(COPY "${OUSTER_EXAMPLE_STATIC_VERSION_FILE}" DESTINATION ${VERSION_GEN_BUILD_DIR}/)
endif()
 
file(READ ${OUSTER_EXAMPLE_VERSION_FILE} OUSTER_EXAMPLE_VERSION)
string(STRIP "${OUSTER_EXAMPLE_VERSION}" OUSTER_EXAMPLE_VERSION)
configure_file(${VERSION_GEN_SOURCE_DIR}/cmake/ousterVersionGen.cpp.in ${VERSION_GEN_BUILD_DIR}/version.cpp @ONLY)

